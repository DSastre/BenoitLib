<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<title></title>
<meta name="Generator" content="Cocoa HTML Writer">
<meta name="CocoaVersion" content="949.54">
<style type="text/css">
p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Helvetica}
p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica; min-height: 22.0px}
p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 18.0px Helvetica}
p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #6e2a1e}
p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco}
p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; min-height: 12.0px}
p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 9.0px Monaco; color: #103fa2}
p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Helvetica; min-height: 17.0px}
p.p11 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Helvetica}
span.s1 {font: 18.0px Helvetica}
span.s2 {text-decoration: underline}
span.s3 {color: #103fa2}
span.s4 {color: #606060}
span.s5 {color: #000000}
span.s6 {color: #002eaf}
span.Apple-tab-span {white-space:pre}
</style>
</head>
<body>
<p class="p1"><span class="s1"><b>MandelClock<span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></span><b>synchronizing the shit</b></p>
<p class="p2">Part of BenoitLib: <span class="s2">http://github.com/cappelnord/BenoitLib</span></p>
<p class="p3"><br></p>
<p class="p4"><b>Basic Setup</b></p>
<p class="p5"><br></p>
<p class="p2">MandelClock does registier its internal clock as the <span class="s3">TempoClock</span>.default. To allow fast access to some MandelClock functions it is a good strategy to set the global variable m to the instance. As the process to follow a MandelClock system is asynchronous it must be done after connecting to a system (or by passing a action, which is performed after connection).</p>
<p class="p3"><br></p>
<p class="p6">// Start a System as a leader</p>
<p class="p7">m = <span class="s3">MandelClock</span>.startLeader(<span class="s4">"YourName"</span>);</p>
<p class="p8"><br></p>
<p class="p6">// Follow a System</p>
<p class="p7"><span class="s3">MandelClock</span>.startFollower(<span class="s4">"YourName"</span>, action: {m = <span class="s3">MandelClock</span>.instance;});</p>
<p class="p8"><br></p>
<p class="p6">// If you know, that the current leader doesn't listen on port 57120 you</p>
<p class="p6">// have to add the port as an argument.</p>
<p class="p7"><span class="s3">MandelClock</span>.startFollower(<span class="s4">"YourName"</span>, 57121, action: {m = <span class="s3">MandelClock</span>.instance;});</p>
<p class="p8"><br></p>
<p class="p6">// Before reconnecting you should either quickly recompile sclang or clear any previous instance.</p>
<p class="p6">// This also stops the process of looking for a leader (if you tried to follow a system)</p>
<p class="p9">MandelClock<span class="s5">.clear;</span></p>
<p class="p8"><br></p>
<p class="p4"><b>Methods</b></p>
<p class="p3"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span>This isn't a complete list of all available methods but these are all methods you should care for at the moment. Please look in the source for more details and more options.<span class="Apple-converted-space"> </span></p>
<p class="p3"><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>*startLeader(name, startTempo=2.0)</b></p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Starts a new MandelClock system with you as the leader.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>*followLeader(name, port=57120, action)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Tries to connect to a running MandelClock system. The port must be the listening port of the MandelClock leader. Action is an optional function which is executed after the MandelClock connection is established. This process is asynchronous. After a successfull connection to the system the MandelClock instace is available through MandelClock.instance.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>*new</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>This shouldn't be called, so no documentation here :-)</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>*clear</b></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Stops the MandelClock, removes als OSCresponders and clears the instance.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>hello</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Sends a hello message, which tells every connected client that you are now part of the system.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>requestHello</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>Asks every connected client to introduce himself (send a hello message).</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>chat(message)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Sends a chat message.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>shout(message)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>Sends a chat message which is displayed more visible. Currently it uses Growl on Mac and Notify on Linux.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>takeLead</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Only as a follower. Release the leader from his duties. You will take the role as the new leader. This also may be necessary if the leader has crashed or isn't available anymore.<span class="Apple-converted-space"> </span></p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>requestTempo(tempo, time)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Only as a follwer.<i> </i>Requests a tempo change in <i>time</i> seconds. If <i>time</i> is set to 0 (or not given at all) the tempo change will be instant. Tempo is given in BPS (2.0 = 120 BPM). The leader will follow the request, unless allowTempoRequests is set to false.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>changeTempo(tempo, time)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Only as a leader. Same as <i>requestTempo</i>, but on the leader side.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>sendMsg(...)</b></p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Same as the method in <span class="s6">NetAddr</span>, but sends to the broadcast address to all registered ports.</p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>display</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Displays a small window with informations on the clock.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>makeTempoProxy(ps)</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Generates a control rate NodeProxy ~tempo in ProxySpace ps.</p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>clearTempoProxy</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>Clears the ~tempo NodeProxy.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p3"><br></p>
<p class="p4"><b>Protocol Specification</b></p>
<p class="p10"><br></p>
<p class="p2">All OSC messages are prefixed. This can be set in MandelClock.sc or as an argument on startup. The /mc/ is the default value which is also used in this specification. All messages are sent over the broadcast address. Some are just important for leaders and other are just important for followers. If not noted otherwise a message has to be send to all known ports.</p>
<p class="p5"><br></p>
<p class="p2">Each message starts with a String, which identifies a follower/leader with a name.</p>
<p class="p5"><br></p>
<p class="p2">Message arguments are notated in the form [type]:[name] where type is one of the four basic OSC message argument types (i: int32, f: float32, s: OSC-string, b: OSC-blob).<span class="Apple-converted-space"> </span></p>
<p class="p5"><br></p>
<p class="p11"><b>Starting up and connecting to a MandelClock System</b></p>
<p class="p10"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span>Setting up a system should be easy. One has to start as a leader and all other clients should do a /mc/requestPorts message (to announce their listening port to the system) and then initialize their clock with the first /mc/clock signal they receive.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p11"><b>Timing</b></p>
<p class="p10"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/clock s:ID, i:serial, f:beats, f:currentTempo</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>This message is the main timing message. It publishs the current timing state of the leader, so any client can adjust to that.<span class="Apple-converted-space"> </span></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>serial: </b>The serial number allows for detecting bad networks and message loss. As UDP doesn't guarantee sequence or message delivery a receiver can check internally with this number if this message is still fresh or not.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>beats: </b>This floating point number represents the current beat. Eights and Sixteenth notes are just fractions of this number (.25, .5, .75).</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>currentTempo:</b> The current tempo (in seconds, so 60 BPM = 1 and 120 BPM = 2) of the leader. If the clients beats match the leader beats then the clients tempo should match the leaders tempo. Otherwise a client has to catch up (or slow down) till they match. If beats differ too much this should be avoided.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/requestTempo s:ID, f:tempo, f:time</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b>Any client can request a tempo change from the leader. The tempo and time is given in seconds (as noted above). A Leader may decide to deny the tempo change. Clients should ignore this message, as they get the new timing with the /bc/clock message. if time is 0 the tempo change is instant. Otherwise the tempo will gradually change. An instant tempo change may introduce timing jitter, clients may have to resynchroinze afterwards.</p>
<p class="p5"><br></p>
<p class="p11"><b>Communication</b></p>
<p class="p5"><br></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/chat s:ID, s:message</b></p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>Just a basic chat message.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/shout s:ID, s:message</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>This is just like a chat message, but it should be displayed more prominently.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/hello s:ID</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>This message is sent from a client to introduce itself. It's more cosmetical.</p>
<p class="p5"><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/requestHello s:ID</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>Every client should answer with a /mc/hello message.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p10"><br></p>
<p class="p11"><b>Leader Management</b></p>
<p class="p10"><br></p>
<p class="p2">The leader has to send the clock signal and it is his responsibility to answer to certain messages to manage the complete system. Any participant can become the leader at any time, even if the current leader is still leader or isn't there anymore. As this is not realy secured by the protocol you should secure your network.</p>
<p class="p5"><br></p>
<p class="p2">A client who doesn't know who the leader is can determine it by one simple rule: Whoever sends the /mc/clock message is the leader.</p>
<p class="p5"><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/takeLead s:ID</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>A client can request to take the the lead with this message. The current leader has to stop his clock signal. The new leader has to start his clock signal immediately. This moment CAN be problematic for keeping up the timing. Implementations must be robust, so that they can somehow cope with it and adjust to the new timing.</p>
<p class="p2"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span>This message also allows a client to take lead in a leaderless system.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p5"><br></p>
<p class="p11"><b>Port Management</b></p>
<p class="p5"><br></p>
<p class="p2">As SuperCollider on Linux may not receive on port 57120 (also there is other Software) any future client may request his port to be part of the system. A leader must relay this port request to all ports he sends to. After following a leader a client must ask the leader for all the ports the leader sends to. Any client must keep book of the current ports, so that he can take on the lead without loosing clients.</p>
<p class="p5"><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/requestPort s:ID, i:port</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>The requestPort message is sent from a future client before following a leader. The leader has to create another sender instance to send to this port. So it is possible for a client to request a port.</p>
<p class="p5"><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/publishPorts s: ID</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>The publishPorts message is sent from a client after following a leader. The leader must answer with the systemPorts message.</p>
<p class="p5"><br></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/systemPorts s: ID, i: port1, i:port2, […], i:portn</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>The leader sends this message a) after a client requested a port and b) after he received the publishPorts message. A receiver has to update its internal port state, which he would use in case he takes the lead. A systemPorts message from another person than the leader should be ignored.</p>
<p class="p5"><br></p>
<p class="p2"><i>&lt;the following messages are implemented, but ports aren't cleaned up yet. maybe even unnecessary?&gt;</i></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span>/mc/pingPort s:ID, i: port</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></b>This message is only send through the port which is also the argument. A client must answer with a pongPort message. This is used to time-out ports, that aren't used anymore. If a port times out the leader should send a systemPorts message.</p>
<p class="p5"><span class="Apple-tab-span">	</span><span class="Apple-tab-span">	</span></p>
<p class="p2"><span class="Apple-tab-span">	</span><b>/mc/pongPort s:ID, i: port</b></p>
<p class="p5"><b><span class="Apple-tab-span">	</span></b></p>
<p class="p2"><b><span class="Apple-tab-span">	</span></b><span class="Apple-tab-span">	</span>The message is send to every port (because the leader port may be unknown at the moment). It can be ignored by any client. A Leader uses this message to check if a port is still used.</p>
</body>
</html>
